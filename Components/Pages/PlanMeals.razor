@page "/plan-meals"
@rendermode InteractiveServer
@inject DBService DbService;
@inject IJSRuntime JsRuntime;
<PageTitle>Plan Meals</PageTitle>

@* <button type="button" class="btn btn-primary" @onclick="DisplayWeek">Change State</button> *@

@* Total macros for a day *@
<div class="container plan-meals">
    <div class="row g-1">
        <div class="col d-flex justify-content-center">
            <BetterRealTimeRecipesSearch CurrentRecipeDataHasChanged="@(value => _currentRecipe = value)"/>
        </div>

        <div class="col d-flex justify-content-center">
            <button type="submit" class="btn btn-primary" @onclick="AddRecipe">Add Recipe</button>
        </div>
        
        <div class="col d-flex justify-content-center">
            <button type="submit" class="btn btn-primary" @onclick="FinalizeMeals">Finalize Meal plan</button>
        </div>
    </div>


    @* Current day total macros *@
    <div class="generel__border-layout p-4 mt-4">
        <button @onclick="PreviousDay" class="btn btn-primary">
            <strong>&lt;</strong>
        </button>
        <button @onclick="NextDay" class="btn btn-primary">
            <strong>></strong>
        </button>

        <div class="row g-1">
            <div class="col d-flex justify-content-center">Day @(_currentTotalMacrosDay + 1)</div>
            <div class="col d-flex justify-content-center">Total
                Calories: @_mealPlanMacrosAndRecipes.DailyMealsList[_currentTotalMacrosDay].TotalDailyMacros.Calories.ToString("0")</div>
            <div class="col d-flex justify-content-center">Total
                Fat: @_mealPlanMacrosAndRecipes.DailyMealsList[_currentTotalMacrosDay].TotalDailyMacros.Fat.ToString("0")</div>
            <div class="col d-flex justify-content-center">Total
                Carbs: @_mealPlanMacrosAndRecipes.DailyMealsList[_currentTotalMacrosDay].TotalDailyMacros.Carbs.ToString("0")</div>
            <div class="col d-flex justify-content-center">Total
                Protein: @_mealPlanMacrosAndRecipes.DailyMealsList[_currentTotalMacrosDay].TotalDailyMacros.Protein.ToString("0")</div>
        </div>
    </div>

</div>

@* All added recipes *@
<div class="container">

    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-1">
        @foreach (var recipe in _mealPlanMacrosAndRecipes.DailyMealsList[_currentTotalMacrosDay].DailyMeals)
        {
            <div class="col p-2">
                <div class="card h-100 generel__border-layout">
                    <img src="data:image/png;base64,@recipe.Base64Image" alt="ops..."
                         class="card-img"/> @* card-img helps the look of the cards. *@
                    <div class="card-header">
                        <h4>@recipe.Name</h4>
                    </div>
                    <div class="card-body border-primary">
                        <p class="card-text">
                            - Calories: @recipe.TotalMacros.Calories.ToString("0") <br>
                            - Carbs: @recipe.TotalMacros.Carbs.ToString("0") <br>
                            - Fats: @recipe.TotalMacros.Fat.ToString("0") <br>
                            - Protein: @recipe.TotalMacros.Protein.ToString("0")
                        </p>
                        <button class="btn btn-danger" @onclick="() => RemoveRecipe(recipe, _currentTotalMacrosDay)">X</button>
                    </div>
                </div>
            </div>
        }
    </div>

</div>

@* Cant go less than 1 toaster *@
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="lower-toast" class="toast ingredient-form" role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-delay="5000">
        <div style="font-size: 20px">
            Cant go lower than day 1.
        </div>
    </div>
</div>

@* Cant go higher than 7 toaster *@
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="higher-toast" class="toast ingredient-form" role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-delay="5000">
        <div style="font-size: 20px">
            Cant go higher than day 7.
        </div>
    </div>
</div>

<script>
    function downloadFile(filename, base64Content) {
        // Convert base64 to blob
        const byteCharacters = atob(base64Content);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'text/plain' });

        // Create download link
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;

        // Trigger download
        document.body.appendChild(link);
        link.click();

        // Cleanup
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
    }
</script>

<StatusMessageToast @ref="_toast"/>

@code{

    int _currentTotalMacrosDay;
    Recipe _currentRecipe = new();
    MealPlan _mealPlanMacrosAndRecipes = new();
    StatusMessageToast _toast;

    private void AddRecipe()
    {
        _mealPlanMacrosAndRecipes.AddMacrosAndRecipeToDay(_currentRecipe, _currentTotalMacrosDay);
        StateHasChanged();
    }

    private void RemoveRecipe(Recipe recipe, int day)
    {
        _mealPlanMacrosAndRecipes.RemoveMacrosAndRecipeToDay(recipe, day);
        StateHasChanged();
    }

    private async Task NextDay()
    {
        if (_currentTotalMacrosDay < 6)
        {
            _currentTotalMacrosDay++;
            StateHasChanged();
        }
        else
        {
            await _toast.ShowToastAsync("Cant go higher than 7");
        }
    }

    private async Task PreviousDay()
    {
        if (_currentTotalMacrosDay > 0)
        {
            _currentTotalMacrosDay--;
            StateHasChanged();
        }
        else
        {
            await _toast.ShowToastAsync("Cant go lower than 1");
        }
    }


    private async Task FinalizeMeals()
    {
        // Example strings to write into the file
        List<string> mealDetails = new List<string> {};

        int counter = 1;
        foreach (DailyMeal dailyMeal in _mealPlanMacrosAndRecipes.DailyMealsList)
        {
            mealDetails.Add($"!---Dag {counter}---!");
            mealDetails.Add($"Total macros \n" +
                            $"  - {dailyMeal.TotalDailyMacros.Calories} \n" +
                            $"  - {dailyMeal.TotalDailyMacros.Carbs} \n" +
                            $"  - {dailyMeal.TotalDailyMacros.Fat} \n" +
                            $"  - {dailyMeal.TotalDailyMacros.Protein} \n");
            foreach (Recipe recipe in dailyMeal.DailyMeals)
            {
                mealDetails.Add($"  - {recipe.Name} \n" +
                                $"    - {recipe.TotalMacros.Calories} \n" +
                                $"    - {recipe.TotalMacros.Carbs} \n" +
                                $"    - {recipe.TotalMacros.Fat} \n" +
                                $"    - {recipe.TotalMacros.Protein} \n" +
                                $"\n");
            }

            counter++;
        }

        // Convert to string content
        string fileContent = string.Join(Environment.NewLine, mealDetails);
    
        // Convert to bytes
        byte[] fileBytes = System.Text.Encoding.UTF8.GetBytes(fileContent);
    
        // Convert to base64 for JavaScript
        string base64 = Convert.ToBase64String(fileBytes);
    
        // Trigger download via JavaScript
        await JsRuntime.InvokeVoidAsync("downloadFile", "mealplan.txt", base64);
    }
}